name: 构建 Kivy APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发构建

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # 增加超时时间，因为构建需要较长时间
    defaults:
      run:
        shell: bash
        working-directory: .  # 明确工作目录为仓库根目录，提高可读性

    steps:
    # 1. 获取代码
    - name: 检出代码
      uses: actions/checkout@v4  
      
    # 2. 检查必要构建配置文件（buildozer.spec）是否存在
    - name: 验证 buildozer.spec 配置文件
      run: |
        set -euo pipefail  # 错误退出机制：命令失败/未定义变量/管道失败均终止流程
        if [ ! -f "buildozer.spec" ]; then
          echo "错误：仓库根目录未找到 buildozer.spec 配置文件，构建无法继续！"
          exit 1
        fi
        echo "✅ 找到 buildozer.spec 配置文件，继续构建流程"
        
    # 3. 安装完整的系统依赖（修复语法错误，优化命令格式）
    - name: 安装完整系统依赖
      run: |
        set -euo pipefail
        sudo apt-get update -y
        # 一次性安装所有必需包，移除续行符后的内联注释（避免Shell语法错误）
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          curl \
          zip \
          unzip \
          tar \
          openjdk-17-jdk \
          autoconf \
          automake \
          libtool \
          pkg-config \
          cmake \
          ninja-build \
          python3-dev \
          python3-pip \
          python3-venv \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo6 \
          libffi-dev \
          libssl-dev \
          libsqlite3-dev \
          sqlite3 \
          swig \
          yasm \
          nasm \
          bison \
          flex
        # 清理apt缓存，减少磁盘占用
        sudo apt-get clean
        
    # 4. 配置 JAVA_HOME 环境变量（极简版本，保留核心功能+添加验证）
    - name: 配置 JAVA_HOME 环境变量
      run: |
        set -euo pipefail
        JAVA_PATH="/usr/lib/jvm/java-17-openjdk-amd64"
        echo "JAVA_HOME=$JAVA_PATH" >> $GITHUB_ENV
        echo "export JAVA_HOME=$JAVA_PATH" >> ~/.bashrc
        echo "export PATH=\$JAVA_HOME/bin:\$PATH" >> ~/.bashrc
        source ~/.bashrc
        # 添加Java版本验证，确认环境生效
        java -version
        echo "✅ JAVA_HOME 配置完成，Java环境生效"
  
    # 5. 设置 Python 环境
    - name: 设置 Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'  # 启用pip缓存，加速后续依赖安装
        
    # 6. 缓存 Buildozer 与 Android 编译环境（优化：添加核心目录缓存）
    - name: 缓存 Python 依赖与 Buildozer 编译环境
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.buildozer
          ./.buildozer/android/platform
        key: ${{ runner.os }}-python3.9-buildozer1.5.0-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-python3.9-buildozer1.5.0-
          
    # 7. 安装 Buildozer 和相关工具（保持 1.5.0 版本不变）
    - name: 安装 Buildozer 和依赖
      run: |
        set -euo pipefail
        # 升级 pip
        python -m pip install --upgrade pip
        # 安装指定版本依赖
        pip install "cython==0.29.36"
        pip install "buildozer==1.6.0"
        pip install "python-for-android==2023.10.0"
        # 验证安装
        buildozer --version
        echo "✅ Buildozer 及其依赖安装完成"
        
    # 8. 临时打包初始化核心目录（解决 clean 所需目录缺失问题，无需等待完整打包）
    - name: 临时初始化 Buildozer 核心目录
      run: |
        set -euo pipefail
        # 执行 debug 命令，仅创建核心目录，无需等待完整构建
        buildozer android debug || echo "⚠️  临时打包已完成目录初始化，继续执行 clean 即可"
        echo "✅ Buildozer 核心目录初始化完成，可正常执行 clean 命令"
        
    # 9. 执行项目缓存清理（此时目录已存在，clean 可正常运行）
    - name: 执行 Buildozer 项目缓存清理
      run: |
        set -euo pipefail
        buildozer android clean
        echo "✅ Buildozer 项目缓存清理完成，旧配置/旧中间产物已清除"
        
    # 10. 正式构建 Android APK（基于干净环境，新配置生效）
    - name: 正式构建 Android APK
      run: |
        set -euo pipefail
        # 执行Buildozer构建，将日志同时输出到终端和build.log文件
        buildozer android debug 2>&1 | tee build.log
        # 验证APK产物是否存在
        if ls ./bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ 检测到APK产物，构建大概率成功！"
        else
          echo "⚠️  未检测到APK产物，构建可能失败，请查看build.log"
        fi
        echo "✅ APK 构建流程执行完成（是否成功请查看产物与日志）"
        
    # 11. 上传 APK 构建产物
    - name: 上传 APK 构建产物
      uses: actions/upload-artifact@v4
      if: always()  # 无论构建成功/失败，都上传产物（方便排查问题）
      with:
        name: kivy-apk-build-result
        path: |
          ./bin/*.apk
          ./build.log
        retention-days: 7  # 产物保留7天，可根据需求调整
