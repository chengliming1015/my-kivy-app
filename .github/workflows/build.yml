name: Build Android APK

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  BUILD_DIR: .

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3-pip \
          python3-dev \
          libffi-dev \
          libssl-dev \
          libncurses5-dev \
          libsqlite3-dev \
          libreadline-dev \
          zip \
          unzip \
          curl \
          wget \
          openjdk-17-jdk \
          libgstreamer1.0-0 \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          pkg-config \
          autoconf \
          automake \
          libtool

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install cython==0.29.33
        pip install buildozer
        pip install kivy

    - name: Create or update buildozer.spec
      run: |
        cd ${{ env.BUILD_DIR }}
        
        # 检查是否存在 main.py
        if [ ! -f "main.py" ]; then
          echo "Creating a sample main.py file"
          cat > main.py << 'EOF'
import kivy
from kivy.app import App
from kivy.uix.label import Label

class MyApp(App):
    def build(self):
        return Label(text='Hello Kivy')

if __name__ == '__main__':
    MyApp().run()
EOF
        fi
        
        # 创建或更新 buildozer.spec
        if [ -f "buildozer.spec" ]; then
          echo "buildozer.spec already exists, updating paths only"
          # 备份原文件
          cp buildozer.spec buildozer.spec.backup
        else
          echo "Creating new buildozer.spec"
          cat > buildozer.spec << 'EOF'
[app]
title = MyApp
package.name = myapp
package.domain = org.test
source.dir = .
source.include_exts = py,png,jpg,kv,atlas
version = 1.0
requirements = python3,kivy
orientation = portrait
fullscreen = 0

[android]
api = 33
minapi = 21
sdk = 33
ndk = 25.1.8937393
skip_update = True
accept_sdk_license = True
arch = arm64-v8a

[buildozer]
log_level = 2
warn_on_root = 1
EOF
        fi

    - name: Setup Android SDK
      run: |
        # 创建目录
        SDK_DIR="$HOME/android-sdk"
        mkdir -p $SDK_DIR
        
        # 下载命令行工具
        echo "Downloading Android SDK command line tools..."
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d $SDK_DIR
        mkdir -p $SDK_DIR/cmdline-tools/latest
        mv $SDK_DIR/cmdline-tools/* $SDK_DIR/cmdline-tools/latest/
        rm -rf $SDK_DIR/cmdline-tools
        
        # 设置环境变量
        echo "ANDROID_SDK_ROOT=$SDK_DIR" >> $GITHUB_ENV
        echo "ANDROID_HOME=$SDK_DIR" >> $GITHUB_ENV
        
        # 接受许可证
        mkdir -p $SDK_DIR/licenses
        echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e\n84831b9409646a918e30573b4ad6d4e4e2fae60e" > $SDK_DIR/licenses/android-sdk-license
        
        # 安装必要组件
        echo "Installing Android SDK components..."
        yes | $SDK_DIR/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1
        $SDK_DIR/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.0" \
          "tools" \
          "patcher;v4"

    - name: Install Android NDK
      run: |
        SDK_DIR="$HOME/android-sdk"
        NDK_VERSION="25.1.8937393"
        
        echo "Installing Android NDK $NDK_VERSION..."
        
        # 使用 sdkmanager 安装 NDK
        yes | $SDK_DIR/cmdline-tools/latest/bin/sdkmanager --install "ndk;$NDK_VERSION" > /dev/null 2>&1
        
        # 检查是否安装成功
        if [ -d "$SDK_DIR/ndk/$NDK_VERSION" ]; then
          echo "NDK installed successfully at: $SDK_DIR/ndk/$NDK_VERSION"
          echo "ANDROID_NDK_HOME=$SDK_DIR/ndk/$NDK_VERSION" >> $GITHUB_ENV
        else
          # 备用安装方法
          echo "Trying alternative NDK installation..."
          wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O android-ndk.zip
          unzip -q android-ndk.zip -d $SDK_DIR
          mv $SDK_DIR/android-ndk-r25b $SDK_DIR/ndk/$NDK_VERSION
          echo "ANDROID_NDK_HOME=$SDK_DIR/ndk/$NDK_VERSION" >> $GITHUB_ENV
        fi

    - name: Configure Build Environment
      run: |
        cd ${{ env.BUILD_DIR }}
        
        # 更新 buildozer.spec 中的路径
        SDK_DIR="$HOME/android-sdk"
        NDK_DIR="$SDK_DIR/ndk/25.1.8937393"
        
        # 确保路径正确
        if [ -d "$NDK_DIR" ]; then
          echo "Setting NDK path in buildozer.spec: $NDK_DIR"
          echo "android.ndk_path = $NDK_DIR" >> buildozer.spec
        fi
        
        if [ -d "$SDK_DIR" ]; then
          echo "Setting SDK path in buildozer.spec: $SDK_DIR"
          echo "android.sdk_path = $SDK_DIR" >> buildozer.spec
        fi
        
        # 显示最终配置
        echo "=== Final buildozer.spec ==="
        cat buildozer.spec

    - name: Build with Buildozer (with detailed logging)
      id: build-apk
      continue-on-error: true
      run: |
        cd ${{ env.BUILD_DIR }}
        
        # 设置环境变量
        export ANDROID_SDK_ROOT="$HOME/android-sdk"
        export ANDROID_HOME="$HOME/android-sdk"
        export ANDROID_NDK_HOME="$ANDROID_SDK_ROOT/ndk/25.1.8937393"
        export ANDROID_NDK_ROOT="$ANDROID_NDK_HOME"
        
        echo "Environment variables:"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        echo "PATH: $PATH"
        
        echo "Starting build..."
        
        # 清理目录
        rm -rf .buildozer bin
        
        # 运行 buildozer 并捕获输出
        {
          echo "=== BUILD START ==="
          date
          echo "=== CLEAN ==="
          buildozer android clean
          echo "=== DEBUG BUILD ==="
          buildozer -v android debug
          echo "=== BUILD END ==="
          date
        } 2>&1 | tee build.log
        
        # 检查 APK 文件
        if find . -name "*.apk" -type f | head -1; then
          echo "APK found!"
          # 确保在 bin 目录
          mkdir -p bin
          find . -name "*.apk" -type f -exec cp {} bin/ \;
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "No APK found!"
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: Check Build Status
      run: |
        cd ${{ env.BUILD_DIR }}
        
        if [[ "${{ steps.build-apk.outputs.BUILD_SUCCESS }}" == "true" ]]; then
          echo "✅ Build succeeded!"
          echo "APK files:"
          find . -name "*.apk" -type f -exec ls -lh {} \;
        else
          echo "❌ Build failed!"
          echo "Displaying build log..."
          
          if [ -f "build.log" ]; then
            echo "=== Last 500 lines of build.log ==="
            tail -500 build.log
            echo "=== Looking for ERROR messages ==="
            grep -i "error\|fail\|exception" build.log | head -50
          else
            echo "No build.log found!"
          fi
          
          # 检查 .buildozer 目录中的日志
          echo "=== Checking .buildozer logs ==="
          find .buildozer -name "*.log" -type f 2>/dev/null | head -5 | while read log; do
            echo "=== $log ==="
            tail -50 "$log"
          done
          
          exit 1
        fi

    - name: Upload APK artifact
      if: steps.build-apk.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: ${{ env.BUILD_DIR }}/bin/*.apk
        retention-days: 7

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ env.BUILD_DIR }}/build.log
          ${{ env.BUILD_DIR }}/.buildozer/**/*.log
        if-no-files-found: warn
        retention-days: 7

    - name: Debug Information
      if: failure()
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== Debug Information ==="
        echo "Current directory: $(pwd)"
        echo "Files:"
        ls -la
        
        echo "=== Python info ==="
        python --version
        pip --version
        
        echo "=== Buildozer info ==="
        buildozer --version 2>&1 || echo "Buildozer not found"
        
        echo "=== Android SDK info ==="
        ls -la $HOME/android-sdk/ || echo "Android SDK not found"
        
        echo "=== Environment variables ==="
        env | grep -i android
