name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: .

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Buildozer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            build-essential \
            git \
            python3-pip \
            python3-dev \
            libffi-dev \
            libssl-dev \
            libncurses5-dev \
            libsqlite3-dev \
            libreadline-dev \
            libtk8.6 \
            libgdm-dev \
            libpcap-dev \
            zip \
            unzip \
            curl \
            wget \
            openjdk-11-jdk

    - name: Install Buildozer
      run: |
        pip3 install --upgrade pip
        pip3 install buildozer
        pip3 install cython

    - name: Check Android SDK installation
      run: |
        echo "=== 检查 Android SDK ==="
        ANDROID_SDK="/usr/local/lib/android/sdk"
        echo "SDK 路径: $ANDROID_SDK"
        
        echo "目录内容:"
        ls -la $ANDROID_SDK/ || echo "SDK 目录不存在"
        
        echo ""
        echo "build-tools 版本:"
        ls -la $ANDROID_SDK/build-tools/ 2>/dev/null || echo "没有 build-tools"
        
        echo ""
        echo "platforms 版本:"
        ls -la $ANDROID_SDK/platforms/ 2>/dev/null || echo "没有 platforms"

    - name: Create minimal buildozer.spec
      run: |
        cd ${{ env.BUILD_DIR }}
        
        if [ ! -f "buildozer.spec" ]; then
          echo "创建 buildozer.spec 文件..."
          
          # 逐行写入，避免多行字符串问题
          echo "[app]" > buildozer.spec
          echo "# 应用标题" >> buildozer.spec
          echo "title = My App" >> buildozer.spec
          echo "package.name = myapp" >> buildozer.spec
          echo "package.domain = org.test" >> buildozer.spec
          echo "source.dir = ." >> buildozer.spec
          echo "source.include_exts = py,png,jpg,kv,atlas" >> buildozer.spec
          echo "version = 1.0" >> buildozer.spec
          echo "requirements = python3,kivy==2.1.0" >> buildozer.spec
          echo "orientation = portrait" >> buildozer.spec
          echo "android.permissions = INTERNET" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "# Android 配置" >> buildozer.spec
          echo "android.api = 34" >> buildozer.spec
          echo "android.minapi = 21" >> buildozer.spec
          echo "android.ndk = 27.3.13750724" >> buildozer.spec
          echo "android.sdk_path = /usr/local/lib/android/sdk" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "[buildozer]" >> buildozer.spec
          echo "log_level = 2" >> buildozer.spec
        else
          echo "使用现有的 buildozer.spec"
          echo "当前配置:"
          cat buildozer.spec
        fi

    - name: Build with Buildozer
      run: |
        cd ${{ env.BUILD_DIR }}
        
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export ANDROID_HOME=/usr/local/lib/android/sdk
        
        echo "=== 开始构建 ==="
        
        echo "清理..."
        buildozer android clean 2>&1 || true
        
        echo "构建 APK..."
        buildozer -v android debug 2>&1 | tee build_output.log
        
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "构建成功！"
        else
          echo "构建可能失败"
          echo "错误信息:"
          tail -100 build_output.log
        fi

    - name: Search for APK files
      run: |
        echo "=== 搜索 APK 文件 ==="
        
        find . -name "*.apk" -type f 2>/dev/null | while read f; do
          echo "找到: $f"
          ls -la "$f"
        done
        
        if [ -z "$(find . -name '*.apk' -type f 2>/dev/null)" ]; then
          echo "未找到任何 APK 文件"
          echo "构建可能失败，检查日志..."
        fi

    - name: Upload APK files
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: |
          bin/*.apk
          **/*.apk
        if-no-files-found: warn
        retention-days: 7

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ env.BUILD_DIR }}/build_output.log
          ${{ env.BUILD_DIR }}/.buildozer/*.log
        retention-days: 7
