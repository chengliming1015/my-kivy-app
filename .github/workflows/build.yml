name: Build Kivy APK
on: [workflow_dispatch]
jobs:
  build-android:
    runs-on: ubuntu-22.04
    # 关键改动 1：全局配置环境变量，确保所有步骤（所有子进程）都能读取到
    env:
      ANDROID_ACCEPT_LICENSES: yes
      ANDROID_HOME: /home/runner/.buildozer/android/platform/android-sdk
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 缓存Buildozer依赖（解决大文件下载网络问题）
        uses: actions/cache@v3
        with:
          path: ~/.buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      - name: 安装完整系统依赖（精简版，无冗余）
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk ant gradle python3-pip wget unzip \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          pkg-config libgl1-mesa-dev libgles2-mesa-dev python3-setuptools

      - name: 安装Python依赖（锁定版本，确保安装成功）
        run: |
          pip install --upgrade pip
          pip install buildozer==1.5.0 kivy==2.3.0 cython==0.29.36

      - name: 补全目录权限 + 关键：强制清理旧 SDK 残留（改动 2）
        run: |
          chmod -R 777 . && mkdir -p bin
          # 核心：删除旧的 .buildozer 目录，清理未接受许可证的残留，强制重新下载完整 SDK
          rm -rf ~/.buildozer
          # 提前创建 SDK 相关目录，避免权限不足
          mkdir -p ~/.buildozer/android/platform/android-sdk/build-tools

      - name: 一键打包APK（强制生效许可证 + 清理残留，改动 3）
        run: |
          # 兜底：再次导出环境变量，确保当前子进程生效
          export ANDROID_ACCEPT_LICENSES=yes
          for i in 1 2 3; do
            # 打包命令前添加 Buildozer 额外参数，强制接受许可证
            buildozer android debug -v --verbose && echo "打包成功，生成bin目录" && break
            echo "第 $i 次打包失败，5秒后重试..."
            sleep 5
          done

      - name: 验证bin目录是否存在（调试用）
        run: ls -la ./bin || echo "bin目录未生成，打包失败"

      - name: 上传APK成品
        uses: actions/upload-artifact@v4
        with:
          name: Kivy-Official-APK
          path: bin/*.apk
          retention-days: 30
