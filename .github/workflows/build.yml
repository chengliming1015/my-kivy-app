name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: .

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3-pip \
          python3-dev \
          zip \
          unzip \
          openjdk-11-jdk

    - name: Install Buildozer
      run: |
        pip3 install buildozer

    - name: Create simple test app
      run: |
        cd ${{ env.BUILD_DIR }}
        # 创建一个最简单的Python文件
        echo "print('Hello World')" > main.py

    - name: Initialize Buildozer
      run: |
        cd ${{ env.BUILD_DIR }}
        buildozer init
        echo "Initialized buildozer.spec"

    - name: Update buildozer.spec
      run: |
        cd ${{ env.BUILD_DIR }}
        # 简化配置，只保留必要的设置
        cat > buildozer.spec << 'CONFIG'
[app]
title = My App
package.name = myapp
package.domain = org.test
source.dir = .
source.include_exts = py
version = 1.0
requirements = python3
orientation = portrait
android.permissions = INTERNET

android.api = 33
android.minapi = 21
android.sdk_path = /usr/local/lib/android/sdk

[buildozer]
log_level = 2
CONFIG

    - name: Build with Buildozer
      run: |
        cd ${{ env.BUILD_DIR }}
        echo "Starting build..."
        buildozer android debug 2>&1 || echo "Build may have failed"

    - name: Check results
      run: |
        cd ${{ env.BUILD_DIR }}
        echo "Checking for APK files..."
        find . -name "*.apk" -type f 2>/dev/null
