name: Kivy Build APK (最终完整版)
on:
  workflow_dispatch:
jobs:
  build-apk:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 切换到Python 3.9
        run: |
          sudo apt-get update -y
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt-get update -y
          sudo apt-get install -y python3.9 python3.9-dev python3.9-distutils
          sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 100
          sudo update-alternatives --config python3
          curl https://bootstrap.pypa.io/get-pip.py | python3.9

      - name: 清理旧缓存与临时文件
        run: |
          rm -rf ./.buildozer
          rm -rf ./bin
          rm -rf ./android-ndk-r25c-linux.zip
          rm -rf ./cmdline-tools.zip
          sudo chmod -R 777 /tmp
          rm -rf /tmp/* || true

      - name: 安装系统级依赖
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            software-properties-common apt-transport-https ca-certificates \
            git python3-pip python3-dev python3-distutils python3-setuptools \
            build-essential cython3 openjdk-17-jdk aidl coreutils util-linux \
            android-sdk-platform-tools unzip wget \
            libssl-dev zlib1g-dev libncurses5-dev libffi-dev libsqlite3-dev \
            libbz2-dev libreadline-dev tk-dev liblzma-dev
          echo "=== 查找cython3实际安装路径 ==="
          CYTHON3_PATH=$(which cython3)
          echo "cython3实际路径：$CYTHON3_PATH"
          if [ -n "$CYTHON3_PATH" ]; then
            sudo ln -s "$CYTHON3_PATH" /usr/bin/cython
            echo "=== Cython映射成功：$CYTHON3_PATH → /usr/bin/cython ==="
            cython --version || true
          else
            echo "=== 错误：cython3未安装成功 ==="
            exit 1
          fi

      - name: 安装Buildozer 1.4.0
        run: |
          python3 -m pip install --upgrade pip
          pip install buildozer==1.4.0
          which buildozer
          buildozer --version

      - name: 执行Buildozer打包APK
        run: |
          export TMPDIR=/tmp/buildozer_temp
          mkdir -p $TMPDIR
          chmod 777 $TMPDIR
          buildozer android debug --verbose

      - name: 上传生成的APK文件
        uses: actions/upload-artifact@v4
        with:
          name: MyKivyHappyNewYearAPK
          path: |
            ./bin/*.apk
            ./.buildozer/**/*.apk
          if-no-files-found: warn
