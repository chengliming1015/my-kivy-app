name: Build Kivy APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 支持手动触发构建

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-11-jdk \
            ant \
            gradle \
            zlib1g-dev \
            libncurses5-dev \
            libgdbm-dev \
            libnss3-dev \
            libssl-dev \
            libreadline-dev \
            libffi-dev \
            wget \
            unzip \
            python3-pip \
            python3-setuptools \
            python3-wheel

      - name: Install Buildozer and dependencies
        run: |
          pip install --upgrade pip
          pip install cython==0.29.36
          pip install buildozer==1.5.0 kivy==2.3.0

      - name: Configure Buildozer environment
        run: |
         # 定义绝对路径（避免 ~ 解析问题，核心优化）
         SDK_ROOT="/home/runner/.buildozer/android/platform/android-sdk"
         NDK_ROOT="/home/runner/.buildozer/android/platform/android-ndk-r25b"
         CMDLINE_TOOLS="/home/runner/.buildozer/android/platform/cmdline-tools"
    
         # 1. 初始化 Buildozer 并创建完整目录结构（带权限）
         buildozer android update -v
         mkdir -p "${SDK_ROOT}" "${NDK_ROOT}" "${CMDLINE_TOOLS}"
         chmod -R 755 /home/runner/.buildozer/android/platform/
    
         # 2. 下载并解压 NDK（绝对路径，保留原有功能）
         wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O ndk.zip
         unzip -q ndk.zip -d /home/runner/.buildozer/android/platform/
         mv /home/runner/.buildozer/android/platform/android-ndk-r25b "${NDK_ROOT}"
         chmod -R 755 "${NDK_ROOT}"
    
         # 3. 下载并解压 SDK 命令行工具（严格符合 sdkmanager 目录要求）
         wget https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O sdk.zip
         unzip -q sdk.zip -d "${CMDLINE_TOOLS}"
         mkdir -p "${SDK_ROOT}/cmdline-tools/latest"
         mv "${CMDLINE_TOOLS}/cmdline-tools/"* "${SDK_ROOT}/cmdline-tools/latest/"
         rm -rf "${CMDLINE_TOOLS}"
         chmod -R 755 "${SDK_ROOT}"
    
         # 4. 配置环境变量（绝对路径，无 ~ 解析问题）
         export ANDROID_HOME="${SDK_ROOT}"
         export PATH="${SDK_ROOT}/cmdline-tools/latest/bin:${PATH}"
         export ANDROID_NDK_HOME="${NDK_ROOT}"
    
         # 5. 自动接受所有许可证（强制静默，避免交互）
         yes | sdkmanager --sdk_root="${SDK_ROOT}" --licenses > /dev/null 2>&1
    
         # 6. 安装 build-tools 及必需组件（带详细日志，确保安装成功）
         sdkmanager --sdk_root="${SDK_ROOT}" --verbose \
         "build-tools;33.0.2" \
         "platforms;android-33" \
         "platform-tools"
    
         # 7. 验证：确认 build-tools 文件夹存在（关键兜底，避免静默失败）
         if [ ! -d "${SDK_ROOT}/build-tools/33.0.2" ]; then
          echo "ERROR: build-tools 33.0.2 安装失败，路径不存在！"
          ls -la "${SDK_ROOT}/"
         exit 1
         fi
    
         # 8. 最终权限配置，确保 Buildozer 可访问
         chmod -R 755 "${SDK_ROOT}"
 
      - name: Build APK
        run: buildozer android debug deploy run -v

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kivy-APK
          path: bin/*.apk
          retention-days: 30
