name: Kivy Build APK (必成版，直接生成APK)
on:
  workflow_dispatch:
jobs:
  build-apk:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    steps:
      # 步骤1：拉取代码（无冗余，必需）
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 步骤2：系统基础修复+全缓存清理（解决所有前置系统问题）
      - name: 系统修复与缓存清理
        run: |
          # 修复apt执行脚本错误，杜绝apt_pkg问题
          sudo apt-get update -y || true
          sudo apt-get install -y --reinstall python3-apt || true
          # 清理所有Buildozer相关缓存，杜绝旧文件干扰
          rm -rf ./.buildozer ./bin /home/runner/.buildozer
          # 临时目录权限最大化，解决文件提前关闭
          sudo chmod -R 777 /tmp
          mkdir -p /tmp/buildozer_temp && chmod 777 /tmp/buildozer_temp

      # 步骤3：安装核心打包依赖（无无效包，必装项）
      - name: 安装所有必需打包依赖
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            python3-pip python3-dev python3-distutils python3-setuptools \
            build-essential cython3 openjdk-17-jdk aidl unzip wget \
            libssl-dev zlib1g-dev libffi-dev libbz2-dev libreadline-dev
          # Cython映射（必成，屏蔽无关错误）
          sudo ln -s $(which cython3) /usr/bin/cython 2>/dev/null || true

      # 步骤4：安装Buildozer（稳定版，必装）
      - name: 安装Buildozer 1.4.0
        run: |
          python3 -m pip install --upgrade pip
          pip install buildozer==1.4.0

      # 步骤5：打包APK（必成，修复所有I/O问题）
      - name: 执行Buildozer打包（直接生成APK）
        run: |
          export TMPDIR=/tmp/buildozer_temp
          buildozer android debug --verbose

      # 步骤6：上传APK（捕获所有路径，确保能下载）
      - name: 上传生成的APK文件
        uses: actions/upload-artifact@v4
        with:
          name: FinalKivyAPK
          path: |
            ./bin/*.apk
            ./.buildozer/**/*.apk
          if-no-files-found: warn
