name: Kivy Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch: # 手动触发构建，方便测试

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash

    steps:
      # 步骤1：拉取远程仓库代码
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 步骤2：安装系统级依赖（适配Ubuntu 22.04，打包必备）
      - name: Install System Dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y \
            software-properties-common apt-transport-https ca-certificates \
            git python3-pip python3-dev python3-distutils python3-setuptools \
            build-essential cython3 libgl1-mesa-dev libgles2-mesa-dev pkg-config \
            autoconf automake libtool cmake openjdk-17-jdk aidl coreutils util-linux \
            android-sdk-platform-tools unzip wget

      # 步骤3：配置打包环境（路径、权限、AIDL兜底，避免工具找不到）
      - name: Configure Buildozer Environment
        run: |
          # 定义核心工作路径（用户权限目录，避免权限报错）
          USER_BIN="/home/runner/.local/bin"
          ANDROID_HOME="/home/runner/.buildozer/android/platform/android-sdk"
          BUILD_TOOLS_PATH="/home/runner/.buildozer/android/platform/android-sdk/build-tools/29.0.3"
          CMDLINE_TOOLS_PATH="/home/runner/.buildozer/android/platform/android-sdk/cmdline-tools/latest"
          export ANDROID_NDK_URL=https://mirrors.tuna.tsinghua.edu.cn/android/repository/android-ndk-r25.2.9519653-linux.zip

          # 创建所需目录（确保目录存在，避免文件找不到）
          mkdir -p "$USER_BIN"
          mkdir -p "$BUILD_TOOLS_PATH"
          mkdir -p "$CMDLINE_TOOLS_PATH"
          mkdir -p "$ANDROID_HOME/platform-tools"
          mkdir -p "$ANDROID_HOME/tools/bin"

          # 配置Cython软链接（Buildozer依赖，确保可调用）
          ln -s /usr/bin/cython3 "$USER_BIN/cython"

          # 下载并配置Android Cmdline Tools（安卓打包核心工具）
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip -d "$ANDROID_HOME/cmdline-tools/"
          mv "$ANDROID_HOME/cmdline-tools/cmdline-tools/"* "$CMDLINE_TOOLS_PATH/"
          rm -rf "$ANDROID_HOME/cmdline-tools/cmdline-tools"

          # 配置sdkmanager软链接（确保安卓许可证可正常接受）
          ln -s "$CMDLINE_TOOLS_PATH/bin/sdkmanager" "$ANDROID_HOME/tools/bin/sdkmanager"
          chmod +x "$ANDROID_HOME/tools/bin/sdkmanager"

          # 配置AIDL多路径兜底（避免Buildozer找不到AIDL工具）
          cp /usr/bin/aidl "$BUILD_TOOLS_PATH/aidl"
          cp /usr/bin/aidl "$ANDROID_HOME/platform-tools/aidl"
          chmod +x "$BUILD_TOOLS_PATH/aidl"
          chmod +x "$ANDROID_HOME/platform-tools/aidl"

          # 配置环境变量（确保所有工具可全局调用）
          echo "PATH=$USER_BIN:$PATH" >> $GITHUB_ENV
          echo "PATH=$CMDLINE_TOOLS_PATH/bin:$PATH" >> $GITHUB_ENV
          echo "PATH=$BUILD_TOOLS_PATH:$PATH" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV

      # 步骤4：安装Python依赖（Buildozer + Kivy，打包必备）
      - name: Install Python Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install --user buildozer

      # 步骤5：接受Android许可证（修复Broken pipe，确保打包顺利）
      - name: Accept Android Licenses
        run: |
          ANDROID_HOME="/home/runner/.buildozer/android/platform/android-sdk"
          chmod +x "$ANDROID_HOME/tools/bin/sdkmanager"
          # 用echo替代yes，解决管道时序差异导致的Broken pipe报错
          echo -e "y\ny\ny\ny\ny\ny\ny\ny" | "$ANDROID_HOME/tools/bin/sdkmanager" --licenses

      # 步骤6：安装Android核心组件（API 31 + Build Tools 29.0.3，兼容Kivy）
      - name: Install Android Components
        run: |
          ANDROID_HOME="/home/runner/.buildozer/android/platform/android-sdk"
          "$ANDROID_HOME/tools/bin/sdkmanager" --update
          "$ANDROID_HOME/tools/bin/sdkmanager" "platforms;android-31" "build-tools;29.0.3" "platform-tools" "ndk;25.2.9519653" > /dev/null 2>&1


      # 步骤7：执行Buildozer打包（生成Android APK文件）
      - name: Build Android APK with Buildozer
        run: |
          buildozer -v android debug

      # 步骤8：上传APK产物（方便下载到本地安装）
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kivy-HappyNewYear2026-APK
          path: ./bin/*.apk
          retention-days: 7
