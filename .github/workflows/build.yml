name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: .

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Buildozer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            build-essential \
            git \
            python3-pip \
            python3-dev \
            libffi-dev \
            libssl-dev \
            libncurses5-dev \
            libsqlite3-dev \
            libreadline-dev \
            libtk8.6 \
            libgdm-dev \
            libpcap-dev \
            zip \
            unzip \
            curl \
            wget \
            openjdk-11-jdk

    - name: Install Buildozer
      run: |
        pip3 install --upgrade pip
        pip3 install buildozer
        pip3 install cython

    - name: Set up Android SDK for Buildozer
      run: |
        # 使用系统已安装的Android SDK
        export ANDROID_HOME=/usr/local/lib/android/sdk
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        
        # 创建Buildozer的Android SDK目录，并链接到系统的SDK
        mkdir -p ~/.buildozer/android/platform
        ln -sfn $ANDROID_HOME ~/.buildozer/android/platform/android-sdk
        
        # 设置环境变量，供后续步骤使用
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        
        # 检查platform-tools是否已安装
        ls -la $ANDROID_HOME/platform-tools || echo "platform-tools not found"
        
        # 检查sdkmanager是否可用
        which sdkmanager || echo "sdkmanager not in PATH"
        sdkmanager --list 2>&1 | head -20 || echo "sdkmanager failed"

    - name: Prepare buildozer.spec
      run: |
        cd ${{ env.BUILD_DIR }}
        if [ -f "buildozer.spec" ]; then
          echo "更新 buildozer.spec..."
          # 移除android.sdk配置（如果存在）
          sed -i '/^android\.sdk\s*=/d' buildozer.spec
          # 确保android.api是33
          sed -i 's/android\.api\s*=\s*[0-9]*/android.api = 33/g' buildozer.spec
          # 设置android.sdk_path指向系统的Android SDK
          echo "android.sdk_path = /usr/local/lib/android/sdk" >> buildozer.spec
        else
          echo "初始化 buildozer.spec..."
          buildozer init
        fi

    - name: Build APK with Buildozer
      run: |
        cd ${{ env.BUILD_DIR }}
        # 设置环境变量
        export ANDROID_HOME=/usr/local/lib/android/sdk
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools:$ANDROID_HOME/cmdline-tools/16.0/bin:$PATH
        
        echo "检查aidl..."
        which aidl || echo "aidl not found"
        find $ANDROID_HOME -name "aidl" -type f 2>/dev/null | head -5
        
        # 构建
        buildozer -v android debug 2>&1 | tail -100

    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 7
