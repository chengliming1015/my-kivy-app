name: æ„å»º Kivy APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æ„å»º

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºæ„å»ºéœ€è¦è¾ƒé•¿æ—¶é—´
    
    steps:
    # 1. è·å–ä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4  # ä½¿ç”¨ v4 è€Œä¸æ˜¯ v6ï¼Œæ›´ç¨³å®š
      
    # 2. å®‰è£…å®Œæ•´çš„ç³»ç»Ÿä¾èµ–ï¼ˆä¸€æ¬¡æ€§å®‰è£…æ‰€æœ‰å¿…éœ€åŒ…ï¼‰
    - name: å®‰è£…å®Œæ•´ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          curl \
          zip \
          unzip \
          tar \
          openjdk-17-jdk \      # ä½¿ç”¨ JDK 17ï¼Œå…¼å®¹æ€§æ›´å¥½
          # è§£å†³ autoconf é—®é¢˜çš„å…³é”®åŒ…
          autoconf \
          automake \
          libtool \
          pkg-config \
          cmake \
          ninja-build \
          # Python å¼€å‘ç¯å¢ƒ
          python3-dev \
          python3-pip \
          python3-venv \
          # å¿…éœ€çš„ç³»ç»Ÿåº“
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          libffi-dev \
          libssl-dev \
          libsqlite3-dev \
          sqlite3 \
          # å…¶ä»–ç¼–è¯‘å·¥å…·
          swig \
          yasm \
          nasm \
          bison \
          flex
        
    # 3. è®¾ç½® Python ç¯å¢ƒ
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4  # ä½¿ç”¨ v4 è€Œä¸æ˜¯ v6
      with:
        python-version: '3.9'
        
    # 4. å®‰è£… Buildozer å’Œç›¸å…³å·¥å…·
    - name: å®‰è£… Buildozer å’Œä¾èµ–
      run: |
        # å‡çº§ pip
        python -m pip install --upgrade pip
        
        # å®‰è£…ç‰¹å®šç‰ˆæœ¬çš„ä¾èµ–ï¼ˆé¿å…å…¼å®¹æ€§é—®é¢˜ï¼‰
        pip install "cython==0.29.36"
        pip install "buildozer==1.5.0"
        pip install "python-for-android==2023.08.24"
        
        # éªŒè¯å®‰è£…
        buildozer --version || echo "Buildozer å®‰è£…å¤±è´¥"
        
    # 5. å‡†å¤‡æ„å»ºç¯å¢ƒ
    - name: é…ç½®æ„å»ºç¯å¢ƒ
      run: |
        # æ¸…ç†æ—§ç¼“å­˜
        rm -rf ~/.buildozer 2>/dev/null || true
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "BUILDOZER_ACCEPT_SDK_LICENSE=1" >> $GITHUB_ENV
        echo "BUILDOZER_ALLOW_ROOT=1" >> $GITHUB_ENV
        
        # å¦‚æœä¸å­˜åœ¨ buildozer.specï¼Œåˆ›å»ºæœ€å°åŒ–ç‰ˆæœ¬
        if [ ! -f "buildozer.spec" ]; then
          echo "åˆ›å»ºé»˜è®¤çš„ buildozer.spec æ–‡ä»¶..."
          cat > buildozer.spec << 'EOF'
[app]
title = My Kivy App
package.name = myapp
package.domain = org.test
source.dir = .
source.include_exts = py,png,jpg,kv,ttf,json
version = 1.0
requirements = python3,kivy
orientation = portrait
fullscreen = 0
android.accept_sdk_license = True
android.api = 33
android.minapi = 28
android.archs = arm64-v8a
android.numeric_version = $(date +%s | cut -c 3-10)

[buildozer]
log_level = 2
warn_on_root = 1
EOF
          echo "âœ… å·²åˆ›å»º buildozer.spec æ–‡ä»¶"
        else
          echo "âœ… å·²å­˜åœ¨ buildozer.spec æ–‡ä»¶"
          
          # ç¡®ä¿ä½¿ç”¨ archs è€Œä¸æ˜¯ arch
          sed -i 's/android\.arch = /android.archs = /g' buildozer.spec 2>/dev/null || true
          
          # ç¡®ä¿æ¥å—è®¸å¯è¯
          if ! grep -q "android.accept_sdk_license" buildozer.spec; then
            sed -i '/^\[app\]/a android.accept_sdk_license = True' buildozer.spec
            echo "âœ… å·²æ·»åŠ  android.accept_sdk_license"
          fi
        fi
        
    # 6. æ„å»º APK
    - name: æ„å»º Android APK
      run: |
        echo "å¼€å§‹æ„å»º APKï¼Œè¿™å¯èƒ½éœ€è¦ 30-60 åˆ†é’Ÿ..."
        
        # è¿è¡Œæ„å»ºï¼Œä¿å­˜æ—¥å¿—
        buildozer android debug 2>&1 | tee build.log
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        if [ $? -eq 0 ] && ls bin/*.apk 1> /dev/null 2>&1; then
          echo "âœ… APK æ„å»ºæˆåŠŸï¼"
          echo "ç”Ÿæˆçš„ APK æ–‡ä»¶ï¼š"
          ls -lh bin/*.apk
        else
          echo "âŒ APK æ„å»ºå¤±è´¥"
          echo "æŸ¥çœ‹æœ€å 50 è¡Œæ—¥å¿—ï¼š"
          tail -50 build.log
          echo "å¸¸è§é”™è¯¯åˆ†æï¼š"
          grep -i "error\|fail\|cannot\|no such" build.log | head -10 || true
          exit 1
        fi
        
    # 7. é‡å‘½å APK æ–‡ä»¶ï¼ˆä¾¿äºåŒºåˆ†ï¼‰
    - name: é‡å‘½å APK æ–‡ä»¶
      if: success()
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        if ls bin/*.apk 1> /dev/null 2>&1; then
          for apk in bin/*.apk; do
            BASENAME=$(basename "$apk" .apk)
            NEW_NAME="${BASENAME}_${TIMESTAMP}.apk"
            mv "$apk" "bin/$NEW_NAME"
            echo "âœ… APK é‡å‘½åä¸º: $NEW_NAME"
          done
        fi
        
    # 8. ä¸Šä¼ ç”Ÿæˆçš„ APK
    - name: ä¸Šä¼  APK æ–‡ä»¶
      uses: actions/upload-artifact@v4  # ä½¿ç”¨ v4 è€Œä¸æ˜¯ v6
      with:
        name: myapp-apk
        path: bin/*.apk
        if-no-files-found: error
        
    # 9. ä¸Šä¼ æ„å»ºæ—¥å¿—ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build.log
        retention-days: 7
        
    # 10. æ˜¾ç¤ºæ„å»ºç»“æœ
    - name: æ˜¾ç¤ºæ„å»ºç»“æœ
      if: always()
      run: |
        if [ -f "build.log" ]; then
          if grep -q "âœ… APK æ„å»ºæˆåŠŸ" build.log; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸå®Œæˆï¼"
            echo ""
            echo "ğŸ“± ä¸‹è½½ APKï¼š"
            echo "1. ç‚¹å‡»å³ä¾§ 'Summary' æ ‡ç­¾"
            echo "2. åœ¨ 'Artifacts' éƒ¨åˆ†æ‰¾åˆ° 'myapp-apk'"
            echo "3. ç‚¹å‡»ä¸‹è½½"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            echo "æŸ¥çœ‹ 'build-logs' è·å–è¯¦ç»†ä¿¡æ¯"
          fi
        fi
