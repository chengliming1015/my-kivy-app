name: Kivy Build APK (完整修复版，不复发旧问题)

on:
  workflow_dispatch: # 仅手动触发，避免自动干扰

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash

    steps:
      # 步骤1：拉取仓库代码（保留之前成功的配置）
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 新增步骤：解决Python 3.10兼容性问题，切换到Python 3.9（稳定兼容Buildozer 1.4.0）
      - name: 切换到Python 3.9（解决临时文件关闭问题，不复发旧问题）
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3.9 python3.9-dev python3.9-distutils
          # 配置Python 3.9为默认，保留之前的依赖逻辑
          sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 100
          sudo update-alternatives --config python3
          # 安装pip for Python 3.9
          curl https://bootstrap.pypa.io/get-pip.py | python3.9

      # 步骤2：清理旧缓存（解决之前的缓存残留问题，避免hostpython3旧文件干扰）
      - name: 清理旧缓存与临时文件
        run: |
          rm -rf ./.buildozer
          rm -rf ./bin
          rm -rf ./android-ndk-r25c-linux.zip
          rm -rf ./cmdline-tools.zip
          # 新增：清理系统临时文件，赋予临时目录完整权限
          sudo chmod -R 777 /tmp
          rm -rf /tmp/* || true

      # 步骤3：安装所有必需依赖（补全之前的libssl-dev、libbz2-dev等，解决hostpython3失败问题）
      - name: 安装系统级依赖（完整无遗漏，不复发旧问题）
        run: |
          # 先更新apt源，确保依赖能下载
          sudo apt-get update -y

          # 安装所有之前验证成功的必需依赖，一个都不少
          sudo apt-get install -y \
            software-properties-common apt-transport-https ca-certificates \
            git python3-pip python3-dev python3-distutils python3-setuptools \
            build-essential cython3 openjdk-17-jdk aidl coreutils util-linux \
            android-sdk-platform-tools unzip wget \
            libssl-dev zlib1g-dev libncurses5-dev libffi-dev libsqlite3-dev \
            libbz2-dev libreadline-dev tk-dev liblzma-dev

          # 精准查找cython3实际路径，再映射为cython（解决当前Cython not found问题，不写死路径）
          echo "=== 查找cython3实际安装路径 ==="
          CYTHON3_PATH=$(which cython3)
          echo "cython3实际路径：$CYTHON3_PATH"

          # 基于实际路径创建软链接，确保Buildozer能识别
          if [ -n "$CYTHON3_PATH" ]; then
            sudo ln -s "$CYTHON3_PATH" /usr/bin/cython
            echo "=== Cython映射成功：$CYTHON3_PATH → /usr/bin/cython ==="
            # 验证映射结果
            cython --version || true
          else
            echo "=== 错误：cython3未安装成功 ==="
            exit 1
          fi

      # 步骤4：安装Buildozer（全局安装1.4.0，解决之前的Exit code 127问题）
      - name: 安装Buildozer 1.4.0（稳定版，不复发命令未找到问题）
        run: |
          python3 -m pip install --upgrade pip
          pip install buildozer==1.4.0

          # 验证Buildozer安装成功
          which buildozer
          buildozer --version

      # 步骤5：打包APK（核心步骤，保留之前成功的命令，无冗余）
      - name: 执行Buildozer打包APK（不复发hostpython3等旧问题）
        run: |
          # 新增：设置临时文件环境变量，避免文件提前关闭
          export TMPDIR=/tmp/buildozer_temp
          mkdir -p $TMPDIR
          chmod 777 $TMPDIR
          # 原有打包命令，保留不变
          buildozer android debug --verbose

      # 步骤6：查找并上传所有APK（捕获所有可能路径，解决之前无Artifacts问题）
      - name: 上传生成的APK文件
        uses: actions/upload-artifact@v4
        with:
          name: MyKivyHappyNewYearAPK
          path: |
            ./bin/*.apk
            ./.buildozer/**/*.apk
          if-no-files-found: warn
